{% extends 'base.html.twig' %}

{% block title %}Liste des candidatures{% endblock %}

{% block body %}
    <div class="container mt-4">
        <h1 class="mb-4">üìã Suivi des candidatures</h1>
        {% for message in app.flashes('success') %}
            <div class="alert alert-success">
                {{ message }}
            </div>
        {% endfor %}
        <a href="{{ path('application_new') }}" class="btn btn-primary mb-3">Nouvelle candidature</a>

        <table class="table table-striped table-bordered">
            <thead class="table-dark">
            <tr>
                <th style="width: 10%;">Poste</th>
                <th style="width: 8%;">Entreprise</th>
                <th style="width: 5%;">Lien</th>
                <th style="width: 10%;">Date de candidature</th>
                <th style="width: 25%;">Prompt pour cr√©er une lettre de motivation</th>
                <th style="width: 20%;">Lettre g√©n√©r√©e</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for application in applications %}
                <tr>
                    <td>{{ application.jobTitle }}</td>
                    <td>{{ application.companyName }}</td>
                    <td>
                        {% if application.jobLink %}
                            <a href="{{ application.jobLink }}" target="_blank">Voir</a>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>{{ application.applicationDate|date('d/m/Y') }}</td>
                    <td>
                        {% if application.motivationLetter is not empty %}
                            <a class="btn btn-primary mb-3" data-bs-toggle="collapse" href="#prompt-{{ application.id }}" role="button" aria-expanded="false" aria-controls="prompt">
                                Afficher le prompt
                            </a>
                            {% for motivation in application.motivationLetter %}
                                <div class="collapse" id="prompt-{{ application.id }}">
                                    <button class="btn btn-sm btn-outline-secondary mt-2" data-prompt="{{ motivation.prompt }}" onclick="copyText(this)">Copier le prompt</button>
                                    <div style="font-size: 10px">
                                        {{ motivation.prompt|nl2br }}
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% set motivationLetter = application.motivationLetter %}
                        {% if motivationLetter is not empty and motivationLetter[0].content is not null %}
                            <a class="btn btn-primary" data-bs-toggle="collapse" href="#lettercontent-{{ application.id }}" role="button" aria-expanded="false" aria-controls="collapseExample">
                                Afficher la lettre
                            </a>
                            {% for motivation in application.motivationLetter %}
                                <div class="collapse" id="lettercontent-{{ application.id }}">
                                    <button class="btn btn-sm btn-outline-secondary mt-2" data-content="{{ motivation.content }}" onclick="copyText(this)">Copier la lettre</button>
                                    <div class="card card-body" style="font-size: 10px">
                                        {{ motivation.content|nl2br }}
                                    </div>
                                    <!-- Bouton Copier -->
                                </div>
                            {% endfor %}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ path('application_edit', {'id': application.id}) }}" class="btn btn-sm btn-outline-primary">Modifier</a>
                        <a href="{{ path('application_delete', {'id': application.id}) }}" class="btn btn-sm btn-outline-danger">Supprimer</a>
                        <a href="{{ path('motivation_letter_reload_prompt', {'id': application.id}) }}" class="btn btn-sm btn-outline-success">Recharger le prompt</a>
                        <a href="{{ path('motivation_letter_edit', {'id': application.id}) }}" class="btn btn-sm btn-outline-success">Ajouter une lettre de motivation</a>
                    </td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="6" class="text-center">Aucune candidature enregistr√©e.</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        // Fonction de copie
        function copyText(button) {
            // R√©cup√©rer le texte depuis l'attribut data-* du bouton
            var text = button.getAttribute('data-prompt') || button.getAttribute('data-content');

            // Cr√©er un √©l√©ment de texte temporaire
            var tempInput = document.createElement('input');
            document.body.appendChild(tempInput);
            tempInput.value = text;
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);

            // Alerte de confirmation
            alert("Texte copi√© !");
        }
    </script>
{% endblock %}
